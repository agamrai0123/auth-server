# Control Flow Diagram - OAuth 2.0 M2M Auth Server

## 1. System Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENT APPLICATION                          â”‚
â”‚                    (Service requesting token)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  POST /token    â”‚
                    â”‚  POST /validate â”‚
                    â”‚  POST /revoke   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                  â”‚                  â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚tokenHandler   â”‚validateHandlerâ”‚revokeHandler  â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
          â”‚                  â”‚                  â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚         Auth Server (Gin Framework)             â”‚
    â”‚  - Request parsing & validation                â”‚
    â”‚  - Authentication & authorization             â”‚
    â”‚  - Token lifecycle management                 â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
          â”‚                  â”‚                  â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚ Database â”‚      â”‚ JWT Ops  â”‚      â”‚ Logging  â”‚
    â”‚ (rqlite) â”‚      â”‚ (HMAC)   â”‚      â”‚ (JSON)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Token Generation Flow (POST /token)

### Request Path: `Client â†’ tokenHandler â†’ Database â†’ JWT â†’ Response`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLIENT REQUEST                                                      â”‚
â”‚ POST /token                                                         â”‚
â”‚ Content-Type: application/json                                      â”‚
â”‚ {                                                                   â”‚
â”‚   "grant_type": "client_credentials",                              â”‚
â”‚   "client_id": "my-service",                                       â”‚
â”‚   "client_secret": "secret123"                                     â”‚
â”‚ }                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   tokenHandler  â”‚
                    â”‚   Validation    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚            â”‚            â”‚
          â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”
          â”‚Verify  â”‚  â”‚Validateâ”‚  â”‚Parse   â”‚
          â”‚Method  â”‚  â”‚JSON    â”‚  â”‚Req     â”‚
          â”‚POST?   â”‚  â”‚Valid?  â”‚  â”‚Fields? â”‚
          â””â”€â”€â”€â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
                â”‚            â”‚           â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Database Ops   â”‚  [Log: DEBUG]
                    â”‚  clientByID()   â”‚  "Processing token request"
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚            â”‚            â”‚
          â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”
          â”‚Query   â”‚  â”‚Parse   â”‚  â”‚Get     â”‚
          â”‚Client  â”‚  â”‚Scopes  â”‚  â”‚Secret  â”‚
          â”‚from DB â”‚  â”‚JSON    â”‚  â”‚        â”‚
          â””â”€â”€â”€â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
                â”‚            â”‚           â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Authenticate   â”‚  [Log: WARN on fail]
                    â”‚  Credentials    â”‚  "Invalid client credentials"
                    â”‚  Match?         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  JWT Generation â”‚  [Log: DEBUG]
                    â”‚  generateJWT()  â”‚  "Client credentials validated"
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚            â”‚            â”‚
          â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”
          â”‚Create  â”‚  â”‚Create  â”‚  â”‚Generateâ”‚
          â”‚Random  â”‚  â”‚JWT     â”‚  â”‚HMAC    â”‚
          â”‚Token   â”‚  â”‚Claims  â”‚  â”‚Sig     â”‚
          â”‚ID      â”‚  â”‚        â”‚  â”‚        â”‚
          â””â”€â”€â”€â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
                â”‚            â”‚           â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Persist Token  â”‚  [Log: INFO]
                    â”‚  insertToken()  â”‚  "JWT token generated"
                    â”‚  in Database    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Return Responseâ”‚  [Log: INFO]
                    â”‚  HTTP 200       â”‚  "Token request successful"
                    â”‚  access_token   â”‚
                    â”‚  token_type     â”‚
                    â”‚  expires_in     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Decision Points:

1. **HTTP Method Check**: POST required
   - âœ— Not POST â†’ `405 Method Not Allowed` [Log: WARN]

2. **JSON Parsing**: Valid JSON format?
   - âœ— Invalid JSON â†’ `400 Bad Request` [Log: WARN]

3. **Client Lookup**: Client exists in database?
   - âœ— Not found â†’ `500 Internal Server Error` [Log: WARN]

4. **Credentials Match**: Secret matches stored secret?
   - âœ— No match â†’ `401 Unauthorized` [Log: WARN]
   - âœ“ Match â†’ Continue

5. **Grant Type**: Is it "client_credentials"?
   - âœ“ Yes â†’ Generate JWT
   - âœ— No â†’ `400 Bad Request`

---

## 3. Token Validation Flow (POST /validate)

### Request Path: `Client â†’ validateHandler â†’ Database â†’ JWT Verify â†’ Response`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLIENT REQUEST (via API Gateway - Nginx)                            â”‚
â”‚ POST /validate                                                      â”‚
â”‚ Authorization: Bearer <jwt_token>                                   â”‚
â”‚ X-Forwarded-For: https://api.example.com/users                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚validateHandler  â”‚
                    â”‚ Entry Point     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Verify HTTP    â”‚  [Log: DEBUG]
                    â”‚  Method = POST? â”‚  "Processing validate request"
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚Extract Headers  â”‚
                    â”‚- Auth header    â”‚
                    â”‚- X-Forwarded-Forâ”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚            â”‚            â”‚
          â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”
          â”‚Auth    â”‚  â”‚X-Fwd   â”‚  â”‚Bearer  â”‚
          â”‚Header  â”‚  â”‚Resourceâ”‚  â”‚Token   â”‚
          â”‚Present?â”‚  â”‚Present?â”‚  â”‚Format? â”‚
          â””â”€â”€â”€â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
                â”‚  NO        â”‚           â”‚
                â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ YES  â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   Extract Bearer Token    â”‚
            â”‚   From: "Bearer XYZ..."   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  validateJWT()             â”‚  [Log: DEBUG]
            â”‚  - Verify Signature       â”‚  "Validating JWT signature"
            â”‚  - Check Expiration       â”‚
            â”‚  - Check Revocation       â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚             â”‚             â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”
   â”‚Parse  â”‚  â”‚Validate â”‚  â”‚Verify   â”‚
   â”‚JWT    â”‚  â”‚HMAC-SHA â”‚  â”‚Exp Time â”‚
   â”‚Claims â”‚  â”‚256 Sig  â”‚  â”‚?        â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
        â”‚             â”‚             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  Check Revocation Status   â”‚  [Log: DEBUG]
            â”‚  revokeToken() lookup      â”‚
            â”‚  Token in revoked list?    â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ YES (Token revoked)       â”‚ NO (Token valid)
        â”‚                           â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”                  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
   â”‚Return â”‚                  â”‚Extract  â”‚
   â”‚invalidâ”‚                  â”‚Scopes   â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”˜                  â”‚from JWT â”‚
        â”‚                     â”‚Claims   â”‚
        â”‚                     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚                          â”‚
        â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                  â”‚Resource URL    â”‚  [Log: DEBUG]
        â”‚                  â”‚from Header     â”‚  "Validating access to resource"
        â”‚                  â”‚In Token        â”‚
        â”‚                  â”‚Scopes?         â”‚
        â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                          â”‚
        â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚              YES â”‚              NO
        â”‚                  â”‚                 
        â”‚          â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”
        â”‚          â”‚Return   â”‚      â”‚Return     â”‚
        â”‚          â”‚ VALID   â”‚      â”‚FORBIDDEN  â”‚
        â”‚          â”‚ 200 OK  â”‚      â”‚ 403       â”‚
        â”‚          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚               â”‚                â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ API Gateway        â”‚
              â”‚ (Nginx) Decision   â”‚
              â”‚ - Allow request?   â”‚
              â”‚ - Block request?   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Decision Points:

1. **Authorization Header**: Present and valid format?
   - âœ— Missing â†’ `401 Unauthorized` [Log: WARN]
   - âœ— Invalid format â†’ `401 Unauthorized` [Log: WARN]

2. **X-Forwarded-For Header**: Present (resource endpoint)?
   - âœ— Missing â†’ `400 Bad Request` [Log: WARN]

3. **JWT Parsing**: Valid JWT structure?
   - âœ— Invalid â†’ `401 Unauthorized` [Log: WARN]

4. **Signature Verification**: HMAC-SHA256 signature valid?
   - âœ— Invalid â†’ `401 Unauthorized` [Log: WARN]

5. **Expiration**: Token not expired?
   - âœ— Expired â†’ `401 Unauthorized` [Log: WARN]

6. **Revocation Check**: Token not in revoked list?
   - âœ— Revoked â†’ `401 Unauthorized` [Log: WARN]

7. **Resource Scope**: Resource URL in token scopes?
   - âœ— Not authorized â†’ `403 Forbidden` [Log: WARN]
   - âœ“ Authorized â†’ `200 OK` with scopes list [Log: INFO]

---

## 4. Token Revocation Flow (POST /revoke)

### Request Path: `Client â†’ revokeHandler â†’ Database â†’ Response`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLIENT REQUEST                                                      â”‚
â”‚ POST /revoke                                                        â”‚
â”‚ Authorization: Bearer <jwt_token>                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ revokeHandler   â”‚
                    â”‚  Entry Point    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Verify HTTP     â”‚  [Log: DEBUG]
                    â”‚ Method = POST?  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚Extract Auth     â”‚
                    â”‚Header & Token   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚            â”‚            â”‚
          â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”
          â”‚Auth    â”‚  â”‚Bearer  â”‚  â”‚Token   â”‚
          â”‚Header  â”‚  â”‚Format  â”‚  â”‚Present?â”‚
          â”‚Present?â”‚  â”‚Valid?  â”‚  â”‚        â”‚
          â””â”€â”€â”€â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
                â”‚            â”‚           â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ All valid
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ validateJWT()   â”‚  [Log: DEBUG]
                    â”‚ Verify Signatureâ”‚  "Validating token format"
                    â”‚ Check Exp Time  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  JWT Valid?     â”‚
                    â”‚ (not expired,   â”‚
                    â”‚  signature ok)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ YES                                     â”‚ NO
        â”‚                                         â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”
   â”‚ Extract Token IDâ”‚           â”‚ Return 401       â”‚
   â”‚ from JWT Claims â”‚           â”‚ Unauthorized     â”‚
   â”‚                 â”‚           â”‚ [Log: WARN]      â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
        â”‚                                         â”‚
        â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                          â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
   â”‚Database Operation     â”‚      â”‚
   â”‚ revokeToken()         â”‚      â”‚
   â”‚ - Mark token revoked  â”‚      â”‚
   â”‚ - Set revoked_at time â”‚      â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
        â”‚                          â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
   â”‚ Check if Update       â”‚      â”‚
   â”‚ Successful?           â”‚      â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
        â”‚                          â”‚
   â”Œâ”€â”€â”€â”€â”´â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”
   â”‚ YES   â”‚              â”‚ NO       â”‚
   â”‚       â”‚              â”‚          â”‚
â”Œâ”€â”€â–¼â”€â”€â”€â”€â”  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”    â”‚
â”‚Return â”‚  â”‚      â”‚Return 500  â”‚    â”‚
â”‚200 OK â”‚  â”‚      â”‚Server Errorâ”‚    â”‚
â”‚{msg}  â”‚  â”‚      â”‚[Log: ERROR]â”‚    â”‚
â””â”€â”€â”¬â”€â”€â”€â”€â”˜  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â”‚
   â”‚       â”‚              â”‚         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚              â”‚
     â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
     â”‚ Response Sent to Client  â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Decision Points:

1. **HTTP Method Check**: POST required?
   - âœ— Not POST â†’ `405 Method Not Allowed` [Log: WARN]

2. **Authorization Header**: Present and valid format?
   - âœ— Missing â†’ `401 Unauthorized` [Log: WARN]
   - âœ— Invalid â†’ `401 Unauthorized` [Log: WARN]

3. **Token Signature**: HMAC valid?
   - âœ— Invalid â†’ `401 Unauthorized` [Log: WARN]

4. **Token Expiration**: Not expired?
   - âœ— Expired â†’ `401 Unauthorized` [Log: WARN]

5. **Database Update**: Successfully marked as revoked?
   - âœ“ Yes â†’ `200 OK` [Log: INFO]
   - âœ— No â†’ `500 Internal Server Error` [Log: ERROR]

---

## 5. Middleware Flow (Per Request)

```
HTTP Request Arrives
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LoggingMiddleware()   â”‚
â”‚ - Generate Request ID â”‚
â”‚ - Log incoming requestâ”‚
â”‚ - Measure latency     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CORSMiddleware()      â”‚
â”‚ - Add CORS headers    â”‚
â”‚ - Handle preflight    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RecoveryMiddleware()  â”‚
â”‚ - Catch panics       â”‚
â”‚ - Return 500 error   â”‚
â”‚ - Log stack trace    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Route Handler         â”‚
â”‚ - tokenHandler       â”‚
â”‚ - validateHandler    â”‚
â”‚ - revokeHandler      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LoggingMiddleware     â”‚
â”‚ - Log response status â”‚
â”‚ - Calculate duration  â”‚
â”‚ - Write response logs â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
      Response Sent
```

---

## 6. Database Query Flow

```
Application Request
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  clientByID()        â”‚
â”‚  SELECT * FROM       â”‚
â”‚  clients WHERE       â”‚
â”‚  client_id = ?       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Parse Result Rows    â”‚
â”‚ - Client ID          â”‚
â”‚ - Client Secret      â”‚
â”‚ - Allowed Scopes JSONâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ getClientScopes()    â”‚
â”‚ Parse JSON scopes    â”‚
â”‚ Convert to []string  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Return Client Struct â”‚
â”‚ with all fields      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. JWT Lifecycle Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ generateJWT(clientID string)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. Get client scopes from DB           â”‚
â”‚ 2. Create random token ID (16 bytes)   â”‚
â”‚ 3. Create Claims struct:               â”‚
â”‚    - client_id                         â”‚
â”‚    - token_id                          â”‚
â”‚    - scopes: []string                  â”‚
â”‚    - exp (expires_at)                  â”‚
â”‚    - iat (issued_at)                   â”‚
â”‚ 4. Create JWT header & payload         â”‚
â”‚ 5. Sign with HMAC-SHA256               â”‚
â”‚ 6. Store token in DB (not revoked)     â”‚
â”‚ 7. Return token string & token_id      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Token Usage by Client                  â”‚
â”‚ - Add to Authorization header          â”‚
â”‚ - Use in API requests                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ validateJWT(tokenString string)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. Parse JWT string                    â”‚
â”‚ 2. Extract Claims                      â”‚
â”‚ 3. Verify HMAC-SHA256 signature        â”‚
â”‚ 4. Check expiration time               â”‚
â”‚ 5. Check token NOT in revoked list     â”‚
â”‚ 6. Return Claims if all valid          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Optional: revokeToken(tokenID)         â”‚
â”‚ - Mark token as revoked                â”‚
â”‚ - Set revoked_at timestamp             â”‚
â”‚ - Future validation will fail          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. Error Handling Flow

```
Any Handler
    â”‚
    â”œâ”€â–º JSON Parsing Error
    â”‚   â””â”€â–º "invalid_request" + "Invalid JSON format"
    â”‚       â””â”€â–º HTTP 400 [Log: WARN]
    â”‚
    â”œâ”€â–º Client Not Found
    â”‚   â””â”€â–º "server_error" + "Internal server error"
    â”‚       â””â”€â–º HTTP 500 [Log: WARN]
    â”‚
    â”œâ”€â–º Invalid Credentials
    â”‚   â””â”€â–º "invalid_client" + "Invalid client credentials"
    â”‚       â””â”€â–º HTTP 401 [Log: WARN]
    â”‚
    â”œâ”€â–º Invalid Token Format
    â”‚   â””â”€â–º "invalid_token" + "Invalid Bearer token format"
    â”‚       â””â”€â–º HTTP 401 [Log: WARN]
    â”‚
    â”œâ”€â–º Expired Token
    â”‚   â””â”€â–º "invalid_token" + "Token expired"
    â”‚       â””â”€â–º HTTP 401 [Log: WARN]
    â”‚
    â”œâ”€â–º Revoked Token
    â”‚   â””â”€â–º "invalid_token" + "Token has been revoked"
    â”‚       â””â”€â–º HTTP 401 [Log: WARN]
    â”‚
    â”œâ”€â–º Resource Not Authorized
    â”‚   â””â”€â–º "insufficient_scope" + "Resource not in token scopes"
    â”‚       â””â”€â–º HTTP 403 [Log: WARN]
    â”‚
    â”œâ”€â–º Database Error
    â”‚   â””â”€â–º "server_error" + "Internal server error"
    â”‚       â””â”€â–º HTTP 500 [Log: ERROR]
    â”‚
    â”œâ”€â–º JWT Signing Error
    â”‚   â””â”€â–º "server_error" + "Internal server error"
    â”‚       â””â”€â–º HTTP 500 [Log: ERROR]
    â”‚
    â””â”€â–º Recovery Panic
        â””â”€â–º "server_error" + Stack trace logged
            â””â”€â–º HTTP 500 [Log: ERROR]
```

---

## 9. Context Flow Through System

```
Request Arrives
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Gin Context Created                 â”‚
â”‚ - Request metadata                  â”‚
â”‚ - Response writer                   â”‚
â”‚ - Headers                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LoggingMiddleware Sets Request ID    â”‚
â”‚ - Generate UUID                     â”‚
â”‚ - Store in context.Set("requestID") â”‚
â”‚ - Log: DEBUG with request_id        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Handler Accesses Request Data       â”‚
â”‚ - c.GetString("requestID")          â”‚
â”‚ - c.Request.Header.Get()            â”‚
â”‚ - c.BindJSON()                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Handler Processes Business Logic    â”‚
â”‚ - Database queries (with timeout)   â”‚
â”‚ - JWT operations                    â”‚
â”‚ - Token validation                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Handler Writes Response             â”‚
â”‚ - c.Header()                        â”‚
â”‚ - c.Status()                        â”‚
â”‚ - c.JSON()                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LoggingMiddleware After Handler     â”‚
â”‚ - Get response status               â”‚
â”‚ - Calculate latency                 â”‚
â”‚ - Log: INFO with metrics            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 10. Logging Entry Points & Data Flow

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Structured Log Entry      â”‚
                    â”‚   (Zerolog)                 â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                      â”‚                      â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”
    â”‚Level   â”‚           â”‚Context     â”‚        â”‚Message    â”‚
    â”‚        â”‚           â”‚Fields      â”‚        â”‚           â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚DEBUG   â”‚           â”‚client_id   â”‚        â”‚"Processingâ”‚
    â”‚INFO    â”‚           â”‚token_id    â”‚        â”‚ token req"â”‚
    â”‚WARN    â”‚           â”‚resource    â”‚        â”‚           â”‚
    â”‚ERROR   â”‚           â”‚error       â”‚        â”‚           â”‚
    â”‚        â”‚           â”‚request_id  â”‚        â”‚           â”‚
    â”‚        â”‚           â”‚duration_ms â”‚        â”‚           â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
          â”‚                    â”‚                       â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚JSON Encoded Log  â”‚
                      â”‚Sent to stdout    â”‚
                      â”‚Or log file       â”‚
                      â”‚(with rotation)   â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 11. Performance Critical Paths

### ğŸš€ Fast Path: Token Validation (Cache-friendly)
```
validateHandler
    â†’ Extract headers (O(1))
    â†’ Parse JWT (O(1))
    â†’ Verify HMAC (O(1))
    â†’ Check claims (O(1))
    â†’ Check revoked (O(log n) database index)
    â†’ Check scope (O(n) small array, typically 2-5 items)
    Total: ~5-10ms per request
```

### ğŸ¢ Slow Path: Token Generation (Database-heavy)
```
tokenHandler
    â†’ Parse request (O(1))
    â†’ clientByID (O(log n) database query)
    â†’ Parse scopes JSON (O(n) small data)
    â†’ generateJWT (O(1) JWT operations)
    â†’ insertToken (O(log n) database insert + index update)
    Total: ~20-50ms per request
```

### ğŸ›‘ Error Path: Database Failure
```
Any handler
    â†’ Database timeout (30 seconds configured)
    â†’ Return 500 error
    â†’ Log ERROR with context
    Total: 30+ seconds in worst case
```

---

## 12. Concurrency & Request Isolation

```
Multiple Concurrent Requests
â”‚
â”œâ”€ Request 1 (client-A asks for token)
â”‚  â””â”€ Gets own Gin Context
â”‚     â””â”€ Isolated database connection from pool
â”‚        â””â”€ Own request logger with unique request_id
â”‚
â”œâ”€ Request 2 (client-B validates token)
â”‚  â””â”€ Gets own Gin Context
â”‚     â””â”€ Isolated database connection from pool
â”‚        â””â”€ Own request logger with unique request_id
â”‚
â””â”€ Request 3 (client-A revokes token)
   â””â”€ Gets own Gin Context
      â””â”€ Isolated database connection from pool
         â””â”€ Own request logger with unique request_id

All requests execute independently without blocking each other
```

---

## Summary

This control flow diagram shows:

âœ… **Three Main Endpoints**: Token generation, validation, revocation  
âœ… **Middleware Chain**: Logging, CORS, Recovery  
âœ… **Database Access Pattern**: Query client â†’ Parse scopes â†’ Return data  
âœ… **JWT Lifecycle**: Creation â†’ Usage â†’ Validation â†’ Revocation  
âœ… **Error Handling**: Clear decision trees for all failure scenarios  
âœ… **Logging Integration**: Context-aware logs at every decision point  
âœ… **Request Isolation**: Concurrent requests handled independently  
âœ… **Performance Paths**: Fast validation vs. slower generation  

The system is designed for:
- **Scalability**: Stateless handlers, database-backed state
- **Observability**: Comprehensive structured logging
- **Reliability**: Error handling on all paths
- **Security**: JWT signature verification, token revocation
